/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2015 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['jquery.sap.global','sap/ui/base/BindingParser','sap/ui/base/ManagedObject','sap/ui/core/XMLTemplateProcessor','sap/ui/model/BindingMode','sap/ui/model/CompositeBinding','sap/ui/model/Context'],function(q,B,M,X,a,C,b){'use strict';var u={},N="http://schemas.sap.com/sapui5/extension/sap.ui.core.template/1",W=M.extend("sap.ui.core.util._with",{metadata:{properties:{any:"any"},aggregations:{child:{multiple:false,type:"sap.ui.core.util._with"}}}}),R=W.extend("sap.ui.core.util._repeat",{metadata:{aggregations:{list:{multiple:true,type:"n/a",_doesNotRequireFactory:true}}},updateList:function(){}});function g(w,S,i){function e(){var o=w.getBinding("any");return o instanceof C?o.getBindings()[i]:o;}return{getModel:function(){return e().getModel();},getPath:function(){var o=e();return o.getModel().resolve(o.getPath(),o.getContext());},getSetting:function(n){if(n==="bindingContexts"||n==="models"){throw new Error("Illegal argument: "+n);}return S[n];}};}function c(w,o,S){function p(I,i){var f=I.formatter;I.mode=a.OneTime;if(f&&f.requiresIContext===true){I.formatter=f.bind(null,g(w,S,i));}}try{p(o);if(o.parts){o.parts.forEach(p);}w.bindProperty("any",o);return w.getBinding("any")?w.getAny():u;}finally{w.unbindProperty("any",true);}}function d(e,L){return e.namespaceURI===N&&l(e)===L;}function l(n){return n.localName||n.baseName;}function s(e){var A,o=e.attributes,t="<"+e.nodeName,i,n;for(i=0,n=o.length;i<n;i+=1){A=o.item(i);t+=" "+A.name+'="'+A.value+'"';}return t+(e.childNodes.length?">":"/>");}return{process:function(r,v,S){var e,D=q.sap.log.isLoggable(q.sap.log.Level.DEBUG),f={},h=0,j;function k(i){if(D){q.sap.log.debug((h<10?"[ ":"[")+h+"] "+Array.prototype.slice.call(arguments,1).join(" "),i&&s(i),"sap.ui.core.util.XMLPreprocessor");}}function m(i){if(D){q.sap.log.debug((h<10?"[ ":"[")+h+"] Finished","</"+i.nodeName+">","sap.ui.core.util.XMLPreprocessor");}}function o(i,n){throw new Error(e+": "+i+s(n));}function p(K){var L=K.childNodes,O,P=[],i,n,Q=false;for(i=0,n=L.length;i<n;i+=1){O=L.item(i);if(O.nodeType===1){P.push(O);}}if(!P.length||!d(P[0],"then")){return null;}for(i=1,n=P.length;i<n;i+=1){O=P[i];if(Q){o("Expected </"+K.prefix+":if>, but instead saw ",O);}if(d(O,"else")){Q=true;}else if(!d(O,"elseif")){o("Expected <"+K.prefix+":elseif> or <"+K.prefix+":else>, but instead saw ",P[i]);}}return P;}function t(V,i,n,K,L){var O=B.complexParser(V,null,K,true)||V;if(O.functionsNotFound){if(K){J('Function name(s) '+O.functionsNotFound.join(", ")+' not found in ',i,null);}return u;}if(typeof O==="object"){O=c(n,O,S);if(O===u){J('Binding not ready in ',i,null);}}else if(L){L();}return O;}function w(P,i,T){var n;T=T||P;H(P,i);while((n=P.firstChild)){T.parentNode.insertBefore(n,T);}}function x(i,n){var K=J.bind(null,'Constant test condition in ',i,null),L,T=i.getAttribute("test"),O;try{O=t(T,i,n,true,K);if(O===u){O=false;}}catch(P){J('Error in formatter of ',i,P);O=false;}L=!!O&&O!=="false";if(D){if(typeof O==="string"){O=JSON.stringify(O);}else if(O===undefined){O="undefined";}else if(Array.isArray(O)){O="[object Array]";}k(i,"test ==",O,"-->",L);}return L;}function y(i,n,K){var V=n.value,L;try{L=t(V,i,K,false);if(L!==u){if(L===undefined){if(D){k(i,"removed attribute",n.name);}i.removeAttribute(n.name);}else{if(D&&L!==n.value){k(i,n.name,"=",L);}n.value=L;}}}catch(O){if(D){q.sap.log.debug(e+': Error in formatter of '+s(i),O,"sap.ui.core.util.XMLPreprocessor");}}}function z(i,n){var K=i.getAttribute("fragmentName"),L;function O(K){var Q=f[K];if(!Q){Q=X.loadTemplate(K,"fragment");f[K]=Q;}Q=Q.cloneNode(true);n.$mFragmentContexts=n.$mFragmentContexts||{};if(n.$mFragmentContexts[K]){q.sap.log.error("Cyclic reference to fragment '"+K+"' ",q.sap.serializeXML(i),"sap.ui.core.util.XMLPreprocessor");return;}h++;k(i,"fragmentName =",K);n.$mFragmentContexts[K]=true;if(l(Q)==="FragmentDefinition"&&Q.namespaceURI==="sap.ui.core"){w(Q,n,i);}else{i.appendChild(Q);w(i,n);}i.parentNode.removeChild(i);n.$mFragmentContexts[K]=false;m(i);h--;}try{L=t(K,i,n,true);if(L!==u){O(L);}}catch(P){J('Error in formatter of ',i,P);}}function A(i,n){var K=p(i),L,T;h++;if(K){T=i;L=K.shift();do{if(x(T,n)){break;}T=L=K.shift();}while(T&&l(T)==="elseif");}else if(x(i,n)){L=i;}if(L){w(L,n,i);}i.parentNode.removeChild(i);m(i);h--;}function E(n,K){var L=n.getAttribute("list")||"",O=B.complexParser(L),P,Q,T,U,V=n.getAttribute("var");if(V===""){o("Missing variable name for ",n);}if(!O){o("Missing binding for ",n);}U=new R();K.setChild(U);O.mode=a.OneTime;U.bindAggregation("list",O);Q=U.getBinding("list");U.unbindAggregation("list",true);T=O.model;if(!Q){o("Missing model '"+T+"' in ",n);}P=Q.getContexts(O.startIndex,O.length);V=V||T;U.setModel(Q.getModel(),V);h++;k(n,"Starting");P.forEach(function(Y,i){var Z=(i===P.length-1)?n:n.cloneNode(true);U.setBindingContext(Y,V);k(n,V,"=",Y.getPath());w(Z,U,n);});m(n);h--;n.parentNode.removeChild(n);}function F(i,n){var K,L,O,P,Q=i.getAttribute("helper"),T,U=i.getAttribute("path"),V,Y=i.getAttribute("var");if(Y===""){o("Missing variable name for ",i);}O=new W();n.setChild(O);K=B.simpleParser("{"+U+"}");Y=Y||K.model;if(Q||Y){L=n.getModel(K.model);if(!L){o("Missing model '"+K.model+"' in ",i);}V=L.resolve(K.path,n.getBindingContext(K.model));if(!V){o("Cannot resolve path for ",i);}if(Q){P=q.sap.getObject(Q);if(typeof P!=="function"){o("Cannot resolve helper for ",i);}T=P(L.createBindingContext(V));if(T instanceof b){L=T.getModel();V=T.getPath();}else if(T!==undefined){if(typeof T!=="string"||T===""){o("Illegal helper result '"+T+"' in ",i);}V=T;}}O.setModel(L,Y);O.bindObject({model:Y,path:V});}else{O.bindObject(U);}h++;k(i,Y,"=",V);if(O.getBindingContext(Y)===n.getBindingContext(Y)){J("Set unchanged path '"+V+"' in ",i,null);O=n;}w(i,O);i.parentNode.removeChild(i);m(i);h--;}function G(n,K){var i,L=n.attributes;if(L){for(i=L.length-1;i>=0;i-=1){y(n,L.item(i),K);}}}function H(K,L){var i,O=K.childNodes,n=O.length,P=new Array(n);for(i=0;i<n;i+=1){P[i]=O.item(i);}for(i=0;i<n;i+=1){I(P[i],L);}}function I(n,i){if(n.nodeType!==1){return;}if(n.namespaceURI===N){switch(l(n)){case"if":A(n,i);return;case"repeat":E(n,i);return;case"with":F(n,i);return;default:o("Unexpected tag ",n);}}else if(n.namespaceURI==="sap.ui.core"&&l(n)==="Fragment"&&n.getAttribute("type")==="XML"){z(n,i);return;}G(n,i);H(n,i);}function J(T,i,n){if(q.sap.log.isLoggable(q.sap.log.Level.WARNING)){q.sap.log.warning(e+": "+T+s(i),n,"sap.ui.core.util.XMLPreprocessor");}}if(typeof S==="string"){e=S;S=v;}else{e=v.caller;}S=S||{};if(D){k(undefined,"Start processing",e);if(S.bindingContexts instanceof b){k(undefined,"undefined =",S.bindingContexts);}else{for(j in S.bindingContexts){k(undefined,j,"=",S.bindingContexts[j]);}}}I(r,new W({models:S.models,bindingContexts:S.bindingContexts}));k(undefined,"Finished processing",e);return r;}};},true);
